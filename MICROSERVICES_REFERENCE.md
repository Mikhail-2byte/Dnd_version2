# Справочник по микросервисам (Example/)

Этот документ описывает существующие микросервисы в папке `Example/`, которые можно использовать как справочный материал для разработки прототипа.

## Обзор микросервисов

### 1. Auth Service (Go) - `Example/auth/`

**Назначение**: Сервис аутентификации и авторизации пользователей.

**Основные возможности:**
- Регистрация пользователей (SignUp)
- Вход в систему (SignIn)
- Проверка токенов (Check)
- Обновление токенов (Refresh)
- Хранение refresh-токенов в PostgreSQL и Redis
- Отправка событий регистрации в Kafka

**Что можно заимствовать:**
- **JWT утилиты** (`pkg/jwt/`) - логика генерации и проверки JWT токенов
- **Хеширование паролей** - паттерны работы с паролями
- **Структура миграций** (`migrations/`) - примеры SQL миграций для таблиц пользователей и токенов
- **Middleware для проверки токенов** (`internal/interceptor/`) - паттерны проверки JWT

**API контракт (gRPC):**
- `SignUp` - регистрация нового пользователя
- `SignIn` - вход в систему, получение токенов
- `Check` - проверка валидности токена
- `Refresh` - обновление access токена

**Полезные файлы:**
- `pkg/jwt/jwt.go` - реализация JWT
- `migrations/` - примеры миграций БД
- `internal/service/v1/auth/` - бизнес-логика аутентификации

---

### 2. User Service (Go) - `Example/user/`

**Назначение**: Управление пользователями и их данными.

**Основные возможности:**
- CRUD операции с пользователями
- Верификация email
- Проверка паролей
- Хранение данных пользователей в PostgreSQL
- Отправка событий верификации email в Kafka через Outbox Pattern

**Что можно заимствовать:**
- **Модели пользователей** - структура данных пользователя
- **Валидация данных** (`pkg/validator/`) - примеры валидации
- **CRUD паттерны** - структура операций с пользователями
- **Outbox Pattern** - для гарантированной доставки событий

**API контракт (gRPC):**
- `CreateUser` - создание пользователя
- `GetUser` - получение пользователя по ID
- `UpdateUser` - обновление данных пользователя
- `DeleteUser` - удаление пользователя

**Полезные файлы:**
- `migrations/` - миграции для таблиц пользователей
- `internal/service/v1/user/` - бизнес-логика работы с пользователями

---

### 3. Gateway (Go) - `Example/gateway/`

**Назначение**: API Gateway - единая точка входа для всех HTTP-запросов.

**Основные возможности:**
- Прием HTTP-запросов от клиентов
- Перевод в gRPC-запросы к другим сервисам
- Обработка аутентификации через JWT
- Предоставление Swagger UI для документации API

**Что можно заимствовать:**
- **Middleware для JWT** (`internal/middleware/`) - проверка токенов в HTTP запросах
- **Структура роутинга** - организация API endpoints
- **Обработка ошибок** (`pkg/apperrors/`) - паттерны обработки ошибок
- **CORS настройки** - конфигурация CORS

**Полезные файлы:**
- `internal/middleware/` - примеры middleware
- `internal/adapter/` - адаптеры для преобразования HTTP ↔ gRPC

---

### 4. Gateway WebSocket (Go) - `Example/gateway_ws/`

**Назначение**: WebSocket Gateway для real-time коммуникации.

**Основные возможности:**
- Обработка WebSocket-соединений
- Обеспечение двусторонней связи для игровых событий
- Использование для чата, бросков кубиков в реальном времени
- Интеграция с Redis для масштабирования

**Что можно заимствовать:**
- **Структура WebSocket обработчиков** - паттерны обработки событий
- **Работа с комнатами (rooms)** - организация WebSocket комнат по game_id
- **Интеграция с Redis** (`pkg/redis/`) - использование Redis для состояния
- **Аутентификация WebSocket** - проверка токенов при подключении

**Полезные файлы:**
- `pkg/httpserver/` - настройка HTTP/WebSocket сервера
- `internal/app/` - структура приложения
- `config.yaml` - пример конфигурации

**Примечание**: Для прототипа мы используем python-socketio, но структура событий и логика могут быть похожими.

---

### 5. Person Create (Python) - `Example/person-create/`

**Назначение**: Создание и управление персонажами D&D.

**Основные возможности:**
- gRPC API для работы с персонажами
- Хранение характеристик персонажей (сила, ловкость, интеллект и т.д.)
- Использование SQLAlchemy для работы с PostgreSQL
- Асинхронная архитектура

**Что можно заимствовать:**
- **SQLAlchemy модели** (`src/models/`) - примеры моделей для персонажей
- **Структура CRUD операций** (`src/crud/`) - паттерны работы с БД
- **Асинхронная работа с БД** (`src/db/session.py`) - настройка async SQLAlchemy
- **Структура проекта Python** - организация кода в Python проекте

**API контракт (gRPC):**
- `CreatePerson` - создание персонажа
- `GetPerson` - получение персонажа по ID
- `UpdatePerson` - обновление персонажа
- `DeletePerson` - удаление персонажа
- `ListPersons` - список персонажей с пагинацией

**Полезные файлы:**
- `src/models/person.py` - модель персонажа
- `src/crud/person.py` - CRUD операции
- `src/db/session.py` - настройка сессий SQLAlchemy
- `requirements.txt` - зависимости Python проекта

**Примечание**: Этот сервис написан на Python и может быть особенно полезен для понимания структуры Python проекта.

---

### 6. Roll Dice (TypeScript/Node.js) - `Example/roll-dice/`

**Назначение**: Бросок игровых кубиков.

**Основные возможности:**
- Поддержка стандартных D&D кубиков (d4, d6, d8, d10, d12, d20)
- Предоставление gRPC и HTTP API
- 3D фронтенд на React Three Fiber

**Что можно заимствовать:**
- **Доменная логика броска кубиков** (`src/domain/dice.ts`) - чистая бизнес-логика
- **Структура TypeScript проекта** - организация кода
- **Примеры тестов** (`src/domain/dice.test.ts`) - юнит-тесты

**API контракт:**
- gRPC: `RollDice` - бросок кубиков
- HTTP: `POST /api/roll` - бросок через HTTP

**Полезные файлы:**
- `src/domain/dice.ts` - логика броска
- `proto/dice_service.proto` - определение gRPC контракта

---

### 7. SMTP Notify (Go) - `Example/smtp_notify/`

**Назначение**: Отправка email-уведомлений.

**Основные возможности:**
- Слушает события из Kafka (user-registered, user-email-verified)
- Отправляет email через SMTP
- Использует батчевую обработку через cron jobs
- Гарантирует доставку через Outbox Pattern

**Что можно заимствовать:**
- **Outbox Pattern** - для гарантированной доставки событий
- **Работа с Kafka** - если понадобится асинхронная обработка событий

**Примечание**: Для прототипа не требуется, но может быть полезно для будущего развития.

---

## Общие паттерны и практики

### 1. Структура проекта
Все Go сервисы следуют похожей структуре:
```
service/
├── cmd/app/          # Точка входа
├── internal/         # Внутренний код
│   ├── adapter/     # Адаптеры
│   ├── service/     # Бизнес-логика
│   └── ...
├── pkg/             # Переиспользуемые пакеты
├── migrations/      # Миграции БД
└── config.yaml      # Конфигурация
```

### 2. Работа с БД
- **Миграции**: Используются SQL миграции для версионирования схемы БД
- **ORM**: Go сервисы используют собственные обертки над SQL, Python использует SQLAlchemy
- **Подключения**: Используются пулы соединений

### 3. Аутентификация
- **JWT токены**: Access и Refresh токены
- **Хеширование паролей**: bcrypt или аналоги
- **Middleware**: Проверка токенов в middleware перед обработчиками

### 4. Конфигурация
- Используются YAML файлы или переменные окружения
- Разделение на development/production конфигурации

### 5. Логирование
- Структурированное логирование (JSON формат)
- Разные уровни логирования (INFO, WARNING, ERROR)

## Что использовать для прототипа

### Рекомендуется заимствовать:
1. **Из Auth Service**: Логику JWT токенов, хеширование паролей
2. **Из Person Create**: Структуру Python проекта, работу с SQLAlchemy
3. **Из Gateway WS**: Структуру WebSocket событий (адаптировать под Socket.IO)
4. **Из User Service**: Модели пользователей, валидацию

### Не требуется для прототипа:
- Kafka (используем прямые вызовы)
- gRPC (используем REST API)
- Микросервисная архитектура (монолит)
- Outbox Pattern (пока не нужен)

## Примеры использования

### Пример 1: Структура JWT токена (из Auth Service)
```go
// Пример структуры payload JWT токена
type TokenPayload struct {
    UserID   string
    Email    string
    ExpiresAt time.Time
}
```

### Пример 2: Модель пользователя (из User Service)
```sql
-- Пример структуры таблицы users
CREATE TABLE users (
    id UUID PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### Пример 3: WebSocket события (из Gateway WS)
```go
// Пример структуры событий (адаптировать для Socket.IO)
// События: game:join, token:move, token:create, token:delete
// Broadcast: game:state, token:moved, player:joined, player:left
```

### Пример 4: SQLAlchemy модель (из Person Create)
```python
# Пример структуры модели
class Person(Base):
    __tablename__ = "person"
    
    id = Column(BigInteger, primary_key=True)
    name = Column(String(255), nullable=False)
    # ... другие поля
```

## Заключение

Микросервисы в папке `Example/` служат как справочный материал для понимания:
- Архитектурных паттернов
- Структуры данных
- API контрактов
- Практик работы с БД и аутентификацией

Для прототипа мы создаем упрощенную монолитную версию, но можем заимствовать проверенные решения из этих микросервисов.

